from __future__ import print_function

from collections import Counter
from optparse import OptionParser
from time import time
import HTMLParser
import codecs
import logging
import math
import numpy as np
import os
import sys

from nltk.data import load as nltk_data_load
from nltk.tag import pos_tag
from nltk.tokenize import word_tokenize

import calibreimport

# Words detected as proper nouns but still abstract enough to not be
# character specific in a book.
OK_NAMES = set(
    [
        "God", "Mr", "English", "America", "Did", "Hey",
        "Ah", "Chapter", "Sorry", "Sunday", "Come",
        "Please", "May", "Lord", "Christmas", "United",
        "Saturday", "Father", "Dad", "Friday", "Hello", "King",
        "Mother", "France", "Jesus", "A", "Hell", "Christ", "Mom",
        "June", "Sir", "Mrs", "Europe", "Tuesday", "July", "September",
        "October", "Wednesday", "U.S.", "April", "March", "Army", "Daddy",
        "November", "Queen", "West", "January", "Well", "Internet",
        "House", "President", "Captain", "CIA", "India", "Me", "Hi",
        "Okay", "FBI", "England", "Earth", "Silver", "Bean", "China",
        "Stone", "Monday", "Germany", "CHAPTER", "August", "Death",
        "ID", "Court", "Emperor", "American", "Inspector", "White house",
        "Carrot", "Church", "Cat", "Thursday", "Angel", "Guild",
        "December", "Moist", "Prince", "Red", "White", "* *", "Mama",
        "University", "Step", "Baron", "Puller", "Chief", "City",
        "Papa", "February", "*", "Wolf", "Egypt", "Empire", "Colonel",
        "Doctor", "Italy", "Congress", "Honor", "Scarlet", "Council",
        "Bear", "Chairman", "Navy", "Lake", "Damn", "No", "Africa",
        "Iraq", "Oh", "Sergeant", "Which", "Gray", "Mum", "Heaven",
        "Australia", "Britain", "Canada", "Keeper", "Palace", "Bell",
        "Hunter", "Uh", "Man", "Battle", "Black", "Bible", "Jihad",
        "Lucky", "Shut", "Pakistan", "Mexico", "Japan", "Wait",
        "Listen", "SUV", "Day", "Jeep", "East", "Glory", "Secret Service",
        "Got", "Madame", "Hand", "Vietnam", "Spain", "Lady", "Bush",
        "Afghanistan", "A.M.", "Tower", "Oxford", "Bureau", "Iran",
        "Dusty", "Master", "Lieutenant", "Time", "Huh", "Marine",
        "Street", "Surprise", "Gardener", "League", "Detective",
        "Dragon", "Sun", "Majesty", "Department", "Scotland Yard",
        "Pope", "Archchancellor", "Him", "Speaker", "Professor",
        "Tinker", "Library", "Old", "Jews", "Watch",
        "World", "Fang", "Jew", "Book", "Catholic", "Latin", "Temple",
        "Mademoiselle", "Count", "Duchess", "Kingdom", "Englishman",
        "Air", "Colon", "Rider", "Muslim", "Israel", "South", "Mace",
        "Imperial", "Bishop", "People", "Haven", "Brown", "Brazil",
        "Ireland", "Admiral", "Fuck", "Mars", "Pacific", "Wales",
        "Doc", "Scotland", "French", "Chinese", "First", "Heralds",
        "Salty", "T-shirt", "Fabel", "Basilica", "Moon", "Shit",
        "Barbie", "Major", "Son", "Coke", "DNA", "Inc.", "Miss",
        "Sit", "Devil", "Abbott", "Atlantic", "Boy", "Paradise",
        "Princess", "Greek", "Welsh", "Ace", "Healer", "Light", "Ruby",
        "Hmm", "Art", "Commander", "Scotch", "Hood", "KGB", "Soviet Union",
        "Air Force", "Pentagon", "Allah", "North", "Iraqi", "NSA",
        "Langley", "Mr. President", "NATO", "GPS", "Gulf", "NASA",
        "Vatican", "German", "Frenchman", "Senate", "Op-Center",
        "Prime Minister", "Wow", "Agency", "Secretary", "Route",
        "Director", "Say", "World War II", "Nazis", "Was", "Middle East",
        "Arabic", "Trust", "Jerusalem", "Nazi", "Office", "Word", "Star",
        "Fleet", "Superintendent", "Senator", "South America", "Service",
        "Satan", "Er", "Battle School", "Fire", "Room", "Thank", "Head",
    ])

ALL_NAMES = [
    (u'God', 1952),
    (u'Did', 1220),
    (u'London', 889),
    (u'English', 795),
    (u'Mr', 776),
    (u'Ah', 769),
    (u'Okay', 724),
    (u'New York', 664),
    (u'Hey', 660),
    (u'England', 638),
    (u'Chapter', 638),
    (u'Sorry', 604),
    (u'Sunday', 567),
    (u'America', 551),
    (u'Come', 530),
    (u'Christmas', 519),
    (u'Please', 500),
    (u'May', 499),
    (u'Lord', 488),
    (u'United', 484),
    (u'Saturday', 483),
    (u'Father', 471),
    (u'Dad', 454),
    (u'George', 447),
    (u'Jack', 432),
    (u'Friday', 424),
    (u'Hello', 417),
    (u'King', 413),
    (u'Mother', 393),
    (u'Monday', 390),
    (u'Jesus', 390),
    (u'FBI', 370),
    (u'France', 368),
    (u'Washington', 362),
    (u'California', 360),
    (u'Peter', 357),
    (u'John', 356),
    (u'A', 355),
    (u'Paris', 344),
    (u'Hell', 329),
    (u'Christ', 319),
    (u'Mom', 316),
    (u'Tom', 310),
    (u'June', 306),
    (u'Earth', 306),
    (u'Sir', 301),
    (u'ID', 300),
    (u'Mrs', 297),
    (u'Europe',295),
    (u'Harry', 295),
    (u'Mary', 294),
    (u'August', 289),
    (u'Frank', 281),
    (u'Tuesday', 276),
    (u'American', 270),
    (u'Henry', 270),
    (u'Thursday', 264),
    (u'July', 261),
    (u'September', 261),
    (u'Joe', 261),
    (u'October', 253),
    (u'Wednesday', 250),
    (u'U.S.', 249),
    (u'April', 249),
    (u'Bill', 249),
    (u'March', 249),
    (u'Daddy', 243),
    (u'Army', 238),
    (u'Michael', 237),
    (u'November', 237),
    (u'Paul', 232),
    (u'David', 228),
    (u'Queen', 227),
    (u'West', 226),
    (u'January', 225),
    (u'Sam', 224),
    (u'Biggles', 223),
    (u'Well', 222),
    (u'Internet', 222),
    (u'House', 221),
    (u'President', 218),
    (u'Captain', 215),
    (u'CIA', 214),
    (u'Mike', 210),
    (u'Boston', 209),
    (u'Germany', 208),
    (u'Death', 208),
    (u'December', 205),
    (u'Hi', 203),
    (u'Charlie', 198),
    (u'Charles', 195),
    (u'Poirot', 195),
    (u'Me', 194),
    (u'China', 193),
    (u'Robert', 192),
    (u'Chicago', 188),
    (u'James', 185),
    (u'India', 185),
    (u'Tommy', 183),
    (u'Ginger', 183),
    (u'Jack', 17287),
    (u'Biggles', 12726),
    (u'Peter', 11918),
    (u'London', 11233),
    (u'Bosch', 9633),
    (u'Poirot', 8779),
    (u'George', 8475),
    (u'Tom', 7289),
    (u'Okay', 6633),
    (u'Sam', 6604),
    (u'Ginger', 6554),
    (u'New York', 6372),
    (u'Harry', 6314),
    (u'Henry', 6004),
    (u'Joe',5761),
    (u'England', 5674),
    (u'Paul', 5303),
    (u'FBI', 5026),
    (u'Michael', 4932),
    (u'Charlie', 4799),
    (u'David', 4792),
    (u'Ben', 4767),
    (u'Frank', 4732),
    (u'John', 4724),
    (u'Cadfael', 4721),
    (u'Ender', 4577),
    (u'Jane', 4566),
    (u'Alvin', 4536),
    (u'Danny', 4535),
    (u'Sarah', 4459),
    (u'Bill', 4397),
    (u'Earth', 4350),
    (u'Mary', 4270),
    (u'Tommy', 4244),
    (u'Silver', 4205),
    (u'William', 4191),
    (u'Richard', 4104),
    (u'Mark', 3952),
    (u'Vimes', 3896),
    (u'Alex', 3786),
    (u'Charles', 3767),
    (u'Algy', 3766),
    (u'Elizabeth', 3676),
    (u'Rachel', 3669),
    (u'Billy', 3544),
    (u'Dean', 3501),
    (u'Mike', 3410),
    (u'Washington', 3404),
    (u'Eric', 3290),
    (u'Bean', 3275),
    (u'Gabriel', 3254),
    (u'China', 3206),
    (u'Paris', 3201),
    (u'Johnny', 3194),
    (u'Laura', 3159),
    (u'Max', 3138),
    (u'Bobby', 3133),
    (u'Jimmy', 3114),
    (u'Ralph', 3106),
    (u'Leo', 3057),
    (u'Hugh', 3046),
    (u'James', 2994),
    (u'Miss Silver', 2951),
    (u'Thomas', 2936),
    (u'Wimsey', 2933),
    (u'Harriet', 2932),
    (u'Eddie', 2929),
    (u'Nick', 2906),
    (u'Jenny', 2886),
    (u'Stone', 2864),
    (u'Miss Marple', 2860),
    (u'Eve', 2855),
    (u'Lee', 2852),
    (u'Emma', 2835),
    (u'Jim', 2763),
    (u'Susan', 2738),
    (u'Edward', 2673),
    (u'Ray', 2664),
    (u'Stephen', 2650),
    (u'Tiffany', 2646),
    (u'Annie', 2606),
    (u'Monday', 2592),
    (u'Langdon', 2559),
    (u'Maggie', 2552),
    (u'Robert', 2552),
    (u'Reacher', 2548),
    (u'California', 2486),
    (u'Philip', 2461),
    (u'Sean', 2459),
    (u'Granny', 2443),
    (u'Quinn', 2429),
    (u'Louis', 2420),
    (u'Margaret', 2405),
    (u'Matt', 2384),
    (u'Jake', 2376),
    (u'Ty', 2375),
    (u'Arthur', 2345),
    (u'Grace', 2337),
    (u'Andy', 2336),
    (u'Will', 2321),
    (u'Duke', 2318),
    (u'Tuppence', 2315),
    (u'Rome', 2293),
    (u'Nafai', 2285),
    (u'Lisa', 2274),
    (u'Rincewind', 2267),
    (u'Germany', 2265),
    (u'Simon', 2262),
    (u'Roger', 2258),
    (u'Anna', 2257),
    (u'Luke', 2256),
    (u'Nell', 2256),
    (u'Michelle', 2199),
    (u'CHAPTER', 2198),
    (u'Web', 2189),
    (u'August', 2182),
    (u'Emerson', 2160),
    (u'Death', 2135),
    (u'Diane', 2132),
    (u'Victor', 2128),
    (u'Troy', 2105),
    (u'General', 2079),
    (u'Lily', 2064),
    (u'Rose', 2034),
    (u'Alan', 2011),
    (u'ID', 2011),
    (u'Court', 1999),
    (u'Roy', 1992),
    (u'Emperor', 1991),
    (u'Klikiss', 1990),
    (u'Adam', 1987),
    (u'Aye', 1967),
    (u'Helen', 1965),
    (u'Roman', 1963),
    (u'Mama', 1963),
    (u'Chicago', 1948),
    (u'Brian', 1932),
    (u'Smith', 1925),
    (u'American', 1924),
    (u'Scott', 1891),
    (u'Inspector', 1888),
    (u'Clay', 1870),
    (u'Vanyel', 1867),
    (u'Marshall', 1865),
    (u'Sophie', 1864),
    (u'Parker', 1859),
    (u'Dan', 1853),
    (u'Ryan', 1850),
    (u'Martin', 1849),
    (u'Dave', 1846),
    (u'Bob', 1840),
    (u'Harrier', 1839),
    (u'Hannah', 1834),
    (u'Roland', 1833),
    (u'Joanna', 1830),
    (u'White House', 1820),
    (u'Ted', 1808),
    (u'Carrot', 1794),
    (u'Rigg', 1789),
    (u'Church', 1782),
    (u'Steve', 1773),
    (u'Cat', 1767),
    (u'Molly', 1754),
    (u'Lucy', 1753),
    (u'Katie', 1744),
    (u'Nanny', 1743),
    (u'Anne', 1736),
    (u'Thursday', 1730),
    (u'Lydia', 1729),
    (u'Angel', 1711),
    (u'Russia', 1710),
    (u'Boston', 1707),
    (u'Claire', 1696),
    (u'Talia', 1693),
    (u'Eleanor', 1688),
    (u'Pete', 1687),
    (u'Polly', 1673),
    (u'Charlotte', 1670),
    (u'Stevie', 1668),
    (u'Amy', 1668),
    (u'Jess', 1667),
    (u'Tony', 1667),
    (u'Guild', 1664),
    (u'December', 1659),
    (u'Virginia', 1657),
    (u'Elric', 1657),
    (u'Junior', 1656),
    (u'Mack', 1643),
    (u'Marcus', 1637),
    (u'Oversoul', 1633),
    (u'Moist', 1630),
    (u'Bertie', 1628),
    (u'Percival', 1626),
    (u'Ellie', 1622),
    (u'Prince', 1619),
    (u'Reggie', 1608),
    (u'Ezio', 1604),
    (u'Robin', 1598),
    (u'Elemak', 1572),
    (u'\x94', 1562),
    (u'Red',1559),
    (u'Duncan', 1559),
    (u'Adrienne', 1545),
    (u'Caleb', 1542),
    (u'Julian', 1540),
    (u'Julia', 1529),
    (u'Kate', 1523),
    (u'Walter', 1523),
    (u'Dylan', 1519),
    (u'Jason', 1517),
    (u'EDF', 1516),
    (u'Hansa', 1510),
    (u'Melissa', 1507),
    (u'Diana', 1500),
    (u'White', 1496),
    (u'Achilles', 1493),
    (u'* *', 1491),
    (u'Harold', 1482),
    (u'University', 1478),
    (u'Travis', 1476),
    (u'Step', 1473),
    (u'Jonathan', 1467),
    (u'Richie', 1466),
    (u'Petra', 1463),
    (u'Spencer', 1456),
    (u'Sandy', 1454),
    (u'Cole', 1451),
    (u'Ivan', 1447),
    (u'Toby', 1446),
    (u'Baron', 1444),
    (u'Puller', 1444),
    (u'Chief', 1442),
    (u'Hercule Poirot', 1438),
    (u'Lucas', 1438),
    (u'Lloyd', 1438),
    (u'Ellen', 1424),
    (u'Christian', 1423),
    (u'Nina', 1418),
    (u'Chris', 1417),
    (u'City', 1415),
    (u'Darcy', 1411),
    (u'Los Angeles', 1410),
    (u'Jackson', 1399),
    (u'York', 1398),
    (u'Arnie', 1397),
    (u'Dirk', 1394),
    (u'Papa', 1389),
    (u'Tyler', 1378),
    (u'Austin', 1377),
    (u'Todd', 1374),
    (u'February', 1373),
    (u'Helena', 1366),
    (u'Albert', 1366),
    (u'Karal', 1366),
    (u'*', 1365),
    (u'Larry', 1362),
    (u'Wolf', 1360),
    (u'Hollywood', 1360),
    (u'Egypt', 1353),
    (u'Ankh-Morpork', 1352),
    (u'Ed', 1351),
    (u'Empire', 1350),
    (u'Zane', 1349),
    (u'Emily', 1347),
    (u'Dominic', 1344),
    (u'Daniel', 1336),
    (u'Andrew', 1332),
    (u'Carson', 1326),
    (u'Colonel', 1326),
    (u'Shaw',1321),
    (u'Alice', 1319),
    (u'Herald', 1319),
    (u'Doctor', 1318),
    (u'Moscow', 1318),
    (u'Canidy', 1315),
    (u'Italy', 1309),
    (u'Greta', 1309),
    (u'Miro', 1307),
    (u'Alfred', 1306),
    (u'Caroline', 1306),
    (u'Kevin', 1306),
    (u'Edgar', 1305),
    (u'Mage-Imperator', 1299),
    (u'Roosevelt', 1297),
    (u'Congress', 1295),
    (u'Honor', 1288),
    (u'Omnius', 1287),
    (u'Scarlet', 1286),
    (u'Graham', 1284),
    (u'Council', 1281),
    (u'Ford', 1274),
    (u'Martha', 1269),
    (u'M. Poirot', 1266),
    (u'Rapp', 1266),
    (u'Isaac', 1264),
    (u'Bear', 1263),
    (u'Chairman', 1262),
    (u'Amanda', 1255),
    (u'Calvin', 1254),
    (u'Mitch', 1254),
    (u'Cadel', 1254),
    (u'Kendi', 1251),
    (u'Basil', 1249),
    (u'Tiercel', 1243),
    (u'Jamie', 1240),
    (u'Jesse', 1235),
    (u'Marty', 1233),
    (u'Times', 1232),
    (u'Iris', 1232),
    (u'Hitler', 1226),
    (u'Ruth', 1225),
    (u'Carter', 1224),
    (u'Maine', 1222),
    (u'Nan', 1222),
    (u'Navy', 1221),
    (u'Lake', 1220),
    (u'Damn', 1219),
    (u'Cleopatra', 1218),
    (u'San Francisco', 1215),
    (u'Seth', 1215),
    (u'Nobby', 1214),
    (u'Julie',1210),
    (u'Texas', 1209),
    (u'Stefan', 1208),
    (u'Logan', 1202),
    (u'Magrat', 1192),
    (u'Tal', 1185),
    (u'Valentine', 1184),
    (u'Allison', 1180),
    (u'Christine', 1179),
    (u'Dennis', 1178),
    (u'Florida', 1177),
    (u'Dale', 1175),
    (u'Ildiran', 1173),
    (u'No', 1172),
    (u'Africa', 1168),
    (u'Mags', 1164),
    (u'Iraq', 1164),
    (u'Quentin', 1158),
    (u'Mercedes', 1157),
    (u'Serena', 1156),
    (u'Chase', 1155),
    (u'Elspeth', 1150),
    (u'Ridcully', 1148),
    (u'Jay', 1146),
    (u'Theo', 1144),
    (u'Oh', 1142),
    (u'Sergeant', 1142),
    (u'Which', 1141),
    (u'Gray', 1140),
    (u'Ellis', 1139),
    (u'Mum', 1139),
    (u'War', 1136),
    (u'Hall', 1134),
    (u'Heaven', 1131),
    (u'Jonesy', 1130),
    (u'Marple', 1129),
    (u'Roamer', 1129),
    (u'Fine', 1128),
    (u'Earl', 1128),
    (u'Irene', 1126),
    (u'McCoy', 1126),
    (u'Australia', 1122),
    (u'Luet', 1119),
    (u'Garion', 1119),
    (u'Page', 1115),
    (u'Gary', 1114),
    (u'Reuben', 1112),
    (u'Greg', 1111),
    (u'Elena', 1109),
    (u'Britain', 1108),
    (u'Colin', 1107),
    (u'Lisey', 1105),
    (u'Holmes', 1105),
    (u'Marsh', 1100),
    (u'Marie', 1100),
    (u'Rosie', 1095),
    (u'Mac', 1092),
    (u'Agnes', 1092),
    (u'Canada', 1088),
    (u'Catherine', 1086),
    (u'Nora', 1084),
    (u'Keeper',1081),
    (u'Palace', 1080),
    (u'Cade', 1076),
    (u'Bell', 1072),
    (u'Harris', 1068),
    (u'Fred', 1068),
    (u'Hunter', 1068),
    (u'Stu', 1067),
    (u'Life', 1067),
    (u'Arthur Stuart', 1065),
    (u'Kiron', 1063),
    (u'Uh', 1063),
    (u'Bunter', 1059),
    (u'Tess', 1059),
    (u'Delia', 1058),
    (u'Peabody', 1058),
    (u'Lois', 1047),
    (u'Rebecca', 1045),
    (u'Victoria', 1044),
    (u'Hal', 1042),
    (u'Daisy', 1042),
    (u'D.C.', 1040),
    (u'Man', 1039),
    (u'Battle', 1038),
    (u'Great', 1036),
    (u'Isabel', 1035),
    (u'Kennedy', 1034),
    (u'Zach', 1034),
    (u'Rocky', 1032),
    (u'Black', 1028),
    (u'Oliver', 1028),
    (u'Micky', 1028),
    (u'Bible', 1023),
    (u'Jihad', 1021),
    (u'Lucky', 1021),
    (u'Cooper', 1020),
    (u'Shel', 1020),
    (u'Katherine', 1018),
    (u'Shut', 1016),
    (u'Heather', 1015),
    (u'Pakistan', 1011),
    (u'Drake', 1011),
    (u'Mexico', 1011),
    (u'Gamache', 1011),
    (u'B', 1011),
    (u'Monk', 1010),
    (u'Lord Peter', 1009),
    (u'Umbo', 1003),
    (u'Mr. Satterthwaite', 1000),
    (u'Joshua', 1000),
    (u'Noah', 999),
    (u'Brandon', 997),
    (u'Japan', 997),
    (u'Dick', 996),
    (u'L.A.', 995),
    (u'Wait', 991),
    (u'Raymond', 990),
    (u'Maurice', 990),
    (u'Ig', 990),
    (u'Mort', 989),
    (u'Listen', 989),
    (u'Kent', 988),
    (u'Liz', 986),
    (u'Cork', 985),
    (u'Ross', 984),
    (u'Xavier', 982),
    (u'Holly', 981),
    (u'Georgie', 980),
    (u'Terry', 980),
    (u'Donovan', 979),
    (u'Tuf', 977),
    (u'Berlin', 976),
    (u'Milo', 976),
    (u'SUV', 975),
    (u'Nancy',975),
    (u'Norman', 974),
    (u'Sasha', 974),
    (u'Day', 973),
    (u'Dr', 970),
    (u'Anthony', 963),
    (u'Jeep', 961),
    (u'Kelly', 960),
    (u'New Orleans', 958),
    (u'East', 956),
    (u'Moira', 955),
    (u'Vegas', 955),
    (u'Ansset', 955),
    (u'Glory', 950),
    (u'Johnson', 948),
    (u'Secret Service', 948),
    (u'Franklin', 947),
    (u'Sarge', 946),
    (u'Natalie', 946),
    (u'Faith', 945),
    (u'Hester', 944),
    (u'Leto', 943),
    (u'Jordan', 942),
    (u'Peggy', 942),
    (u'Joseph', 942),
    (u'Mason', 942),
    (u'Dom', 941),
    (u'Avery', 940),
    (u'Got', 940),
    (u'Madame', 940),
    (u'Miriam', 934),
    (u'Al', 932),
    (u'Hand', 931),
    (u'Annabelle', 931),
    (u'Vietnam', 930),
    (u'Lou', 930),
    (u'Nice', 930),
    (u'Derry', 928),
    (u'Hilary', 928),
    (u'M', 927),
    (u'Spain', 925),
    (u'Lady', 924),
    (u'Frankie', 924),
    (u'Fiona', 922),
    (u'Bram', 922),
    (u'\x93I', 922),
    (u'Erasmus', 919),
    (u'Nigel', 917),
    (u'Bush', 916),
    (u'Afghanistan', 916),
    (u'Meg', 915),
    (u'Morrison', 912),
    (u'Walt', 910),
    (u'A.M.', 909),
    (u'Tucker', 908),
    (u'Carol', 907),
    (u'Tower', 907),
    (u'Firesong', 906),
    (u'Joey', 905),
    (u'Oxford', 903),
    (u'Graff', 902),
    (u'Ethan', 902),
    (u'Stile', 901),
    (u'Bureau', 900),
    (u'Iran', 897),
    (u'Rutledge', 897),
    (u'Sano', 894),
    (u'Greenspan', 893),
    (u'Dusty', 892),
    (u'Valdemar', 891),
    (u'Naomi', 891),
    (u'Alexander', 889),
    (u'Ramses', 889),
    (u'Marina', 888),
    (u'Master', 886),
    (u'Lieutenant', 886),
    (u'Ann', 885),
    (u'Time', 884),
    (u'Norma', 881),
    (u'Baker', 881),
    (u'Jessica', 879),
    (u'Russian', 877),
    (u'Huh', 876),
    (u'Marine', 876),
    (u'Street', 876),
    (u'Geoffrey', 875),
    (u'Finn', 874),
    (u'Surprise', 873),
    (u'Beth', 873),
    (u'Nikki', 872),
    (u'Marco', 871),
    (u'Gardener', 870),
    (u'Gage', 868),
    (u'League', 868),
    (u'Denver', 867),
    (u'Detective', 867),
    (u'Angua', 866),
    (u'Dragon', 866),
    (u'Ned', 865),
    (u'Sun', 865),
    (u'Angie', 863),
    (u'Jacob', 861),
    (u'Violet', 858),
    (u'Lincoln', 858),
    (u'DeAnne', 857),
    (u'Campbell', 857),
    (u'Anderson', 856),
    (u'Laurel', 856),
    (u'Darkwind', 855),
    (u'Chatterton', 854),
    (u'Majesty', 853),
    (u'Raf', 853),
    (u'Department', 853),
    (u'Morgan', 853),
    (u'Percy', 851),
    (u'Scotland Yard', 851),
    (u'Vetinari', 849),
    (u'Madeleine', 847),
    (u'Lusitania', 846),
    (u'Anton', 846),
    (u'Judith', 845),
    (u'Pope', 844),
    (u'Kohler', 844),
    (u'Thatcher', 844),
    (u'Cal', 843),
    (u'Lili', 842),
    (u'Bobbi', 840),
    (u'Archchancellor', 838),
    (u'Him', 835),
    (u'Hong Kong', 835),
    (u'Jared', 835),
    (u'Jo', 833),
    (u'Speaker', 832),
    (u'New York Times', 832),
    (u'Hastings', 831),
    (u'Robie', 828),
    (u'Professor', 828),
    (u'Lulu', 827),
    (u'Penny', 825),
    (u'Patrick', 824),
    (u'Jerry', 824),
    (u"Jora'h", 821),
    (u'State', 821),
    (u'Sydney', 819),
    (u'Teddy', 819),
    (u'Tinker', 819),
    (u'Isobel', 818),
    (u'Library', 818),
    (u'Phil', 818),
    (u'Old', 817),
    (u'Harrison', 817),
    (u'Nanny Ogg', 816),
    (u'Martie', 813),
    (u'Keith', 813),
    (u'Gwen', 813),
    (u'Katerina', 812),
    (u'Williams', 810),
    (u'Jews', 810),
    (u'Gloria', 807),
    (u'Leonard', 806),
    (u'Watch', 803),
    (u'Wallander', 803),

    (u'Randy', 1649),
    (u'Eliza', 1593),
    (u'Miranda', 903),
    (u'Cambridge', 883),
    (u'World', 855),
    (u'Fang', 855),
    (u'Jew', 850),
    (u'Book', 845),
    (u'Catholic', 831),
    (u'Latin', 827),
    (u'Temple', 827),
    (u'Mademoiselle', 816),
    (u'Count', 811),
    (u'Duchess', 811),
    (u'O', 811),
    (u'Kingdom', 808),
    (u'Englishman', 806),
    (u'Lewis', 804),
    (u'Air', 804),
    (u'Griffin', 802),
    (u'Elliot', 802),
    (u'Vor', 802),
    (u'Thad', 801),
    (u'Colon', 800),
    (u"An'desha", 800),
    (u'Rider', 799),
    (u'Mildred', 798),
    (u'Muslim', 797),
    (u'Israel', 796),
    (u'Sara', 796),
    (u'Georgia', 796),
    (u'Lane', 795),
    (u'Manhattan', 795),
    (u'South', 795),
    (u'Augusta', 794),
    (u'Mace', 794),
    (u'Bennett', 793),
    (u'Tristan', 793),
    (u'Imperial', 793),
    (u'Benny', 789),
    (u'Sherlock', 788),
    (u'Bishop', 788),
    (u'Saryon', 786),
    (u'People', 784),
    (u'Remi', 784),
    (u'Haven', 782),
    (u'Ma', 781),
    (u'Brown', 780),
    (u'Bonnie', 780),
    (u'Stan', 778),
    (u'Dinah', 776),
    (u'Maud', 776),
    (u'Miller', 775),
    (u'Brazil', 774),
    (u'Teri',773),
    (u'Taylor', 769),
    (u'Ireland', 769),
    (u'Admiral', 767),
    (u'Chuck', 767),
    (u'Sylvia', 767),
    (u'Sigmund', 766),
    (u'Theroc', 765),
    (u'Fuck', 762),
    (u'Mars', 761),
    (u'Pacific', 761),
    (u'Francis', 759),
    (u'Celeste', 758),
    (u'Shedemei', 758),
    (u'Einar', 757),
    (u'Ethel', 757),
    (u'Wales', 756),
    (u'Lena', 756),
    (u'LuAnn', 755),
    (u'Vera', 755),
    (u'French', 755),
    (u'Doc', 754),
    (u'Scotland', 753),
    (u'Savannah', 753),
    (u'Venice', 752),
    (u'Chinese', 752),
    (u'First', 752),
    (u'Jed', 751),
    (u'Heralds', 750),
    (u'Felix', 750),
    (u'Nicholas', 749),
    (u'Rob', 749),
    (u'Salty', 748),
    (u'T-shirt', 746),
    (u'Fabel', 745),
    (u'Miles', 745),
    (u'Rita', 744),
    (u'Jeremy', 744),
    (u'Buick', 744),
    (u'Basilica', 743),
    (u'Moon', 743),
    (u'Shit', 743),
    (u'Antony', 742),
    (u'Tycho', 742),
    (u'Barbie', 742),
    (u'Derek', 741),
    (u'Owen', 740),
    (u'Olivia', 740),
    (u'Nira', 739),
    (u'Freddy', 738),
    (u'Cohen', 737),
    (u'Barbara', 737),
    (u'Lizzie', 735),
    (u'Cynthia', 735),
    (u'Regan', 734),
    (u'Ricky', 732),
    (u'Major', 730),
    (u'Son', 730),
    (u'Sally', 730),
    (u'Coke', 730),
    (u'DNA', 729),
    (u'Volodya', 729),
    (u'Lyon', 726),
    (u'Mrs Oliver', 725),
    (u'Karen', 725),
    (u'Caesar', 724),
    (u'Inc.', 722),
    (u'New York City', 722),
    (u'Miss', 721),
    (u'Curtis', 721),
    (u'Styx', 717),
    (u'Tad', 716),
    (u'Igor', 716),
    (u'Sit', 715),
    (u'Cassie', 714),
    (u'Devil', 714),
    (u'Shrewsbury', 714),
    (u'Tim', 714),
    (u'Tia', 713),
    (u'Sadie', 712),
    (u'Abbott', 712),
    (u'Bene Gesserit', 711),
    (u'Atlantic', 711),
    (u'Boy', 709),
    (u'Aliena', 705),
    (u'Matthew', 705),
    (u'Beverly', 705),
    (u'Seattle', 704),
    (u'Paradise', 702),
    (u'Princess', 702),
    (u'C', 701),
    (u'Gillette', 700),
    (u'Brutha', 700),
    (u'Wolfe', 698),
    (u'Lem', 698),
    (u'Erin', 698),
    (u'Van', 697),
    (u'Bren', 697),
    (u'Greek', 696),
    (u'Glenda', 695),
    (u'Amberdrake', 695),
    (u'Chester', 695),
    (u"Muad'Dib", 693),
    (u'Maggot', 693),
    (u'Granny Weatherwax', 693),
    (u'Welsh', 692),
    (u'Cameron', 692),
    (u'Issib', 691),
    (u'Zeke', 691),
    (u'Betty', 691),
    (u'Libby', 691),
    (u'Cora', 690),
    (u'Ace', 690),
    (u'Rosa', 690),
    (u'Wolff', 689),
    (u'Loaf', 688),
    (u'Bel', 688),
    (u'Bisochim', 687),
    (u'Don', 686),
    (u'Malcolm', 686),
    (u'P.M.', 685),
    (u'Healer', 682),
    (u'Ruby', 681),
    (u'Dorothy', 680),
    (u'Light', 679),
    (u'Jaden', 679),
    (u'Brother Cadfael', 677),
    (u'Magiere', 676),
    (u'Judge', 675),
    (u'Willie', 675),
    (u'Hmm', 675),
    (u'Colt', 675),
    (u'Lyra', 675),
    (u'Maureen', 674),
    (u'Maria', 674),
    (u'Las Vegas', 673),
    (u'Art', 672),
    (u'Commander', 672),
    (u'Orem', 671),
    (u'Jago', 671),
    (u'Lenny', 670),
    (u'Elv', 669),
    (u'Dream', 668),
    (u'Abigail', 668),
    (u'Gideon', 667),
    (u'Scotch', 665),

    (u'Clark', 2693),
    (u'Hood', 2596),
    (u'Rodgers', 2197),
    (u'Moore', 1718),
    (u'Herbert', 1663),
    (u'Ron', 1586),
    (u'KGB', 1458),
    (u'Chavez', 1341),
    (u'Megan', 1289),
    (u'Nate', 1259),
    (u'Kyle', 1103),
    (u'Soviet Union', 1102),
    (u'Air Force', 1093),
    (u'Leif', 1008),
    (u'Mississippi', 949),
    (u'Pentagon', 926),
    (u'Allah', 914),
    (u'Memphis', 902),
    (u'Robbie', 896),
    (u'North', 893),
    (u'Hank', 889),
    (u'Iraqi', 888),
    (u'Rick', 877),
    (u'Cheyenne', 876),
    (u'NSA', 874),
    (u'Langley', 858),
    (u'Dallas', 853),
    (u'Mr. President', 852),
    (u'Cathy', 850),
    (u'Josh', 848),
    (u'NATO', 834),
    (u'Wally', 817),
    (u'Hugo', 810),
    (u'Melanie', 794),
    (u'Carl', 776),
    (u'Trent', 775),
    (u'GPS', 774),
    (u'Atlanta', 767),
    (u'Morris', 767),
    (u'Gulf', 767),
    (u'Stanley', 763),
    (u'Jones', 762),
    (u'Abby', 753),
    (u'Hill', 742),
    (u'Beijing', 738),
    (u'NASA', 738),
    (u'Philadelphia', 734),
    (u'Ramirez', 732),
    (u'Vatican', 731),
    (u'German', 731),
    (u'Frenchman', 730),
    (u'Honda', 726),
    (u'Senate', 724),
    (u'Op-Center', 720),
    (u'Toni', 717),
    (u'Prime Minister', 716),
    (u'Glock', 714),
    (u'Wow', 708),
    (u'Baltimore', 707),
    (u'Agency', 707),
    (u'McCaskey', 703),
    (u'Wright', 703),
    (u'Herman', 702),
    (u'Howard', 701),
    (u'Secretary', 700),
    (u'Maj', 698),
    (u'Cairo', 695),
    (u'Route', 695),
    (u'Director', 692),
    (u'Say', 691),
    (u'Sheila', 688),
    (u'World War II', 688),
    (u'Sharon', 688),
    (u'Newton', 687),
    (u'Nazis', 686),
    (u'Buddy', 686),
    (u'Was', 684),
    (u'Middle East', 683),
    (u'Justice', 683),
    (u'Wendy', 680),
    (u'Arabic', 680),
    (u'Trust', 678),
    (u'Bella', 672),
    (u'Wallace', 668),
    (u'Maryland', 668),
    (u'Emmy', 668),
    (u'Kris', 668),
    (u'Angela', 667),
    (u'Camel', 667),
    (u'Wells', 665),
    (u'Nightingale', 665),
    (u'Connie', 665),
    (u'Davis', 664),
    (u'New Jersey', 664),
    (u'Suze', 663),
    (u'BMW', 663),
    (u'Jerusalem', 663),
    (u'Jor-El', 662),
    (u'Nazi', 662),
    (u'Jean', 661),
    (u'Mass', 659),
    (u'Ken', 659),
    (u'Guy', 659),
    (u'Office', 658),
    (u'Winston', 658),
    (u'Sammy', 658),
    (u'Bethia', 657),
    (u'Freddie',657),
    (u'Pennsylvania', 656),
    (u'Daav', 656),
    (u'Word', 655),
    (u'Stalhein', 655),
    (u'Katya', 655),
    (u'Jervis', 655),
    (u'Griff', 654),
    (u'Danielle', 654),
    (u'Tokyo', 653),
    (u'Livie', 653),
    (u'Callie', 652),
    (u'Star', 651),
    (u'Barry', 651),
    (u'Reece', 650),
    (u'Rasa', 650),
    (u'Lia', 650),
    (u'Fleet', 650),
    (u'Carla', 650),
    (u'Kit', 649),
    (u'Craig', 649),
    (u'Superintendent', 649),
    (u'Wilson', 649),
    (u'Ponder', 648),
    (u'Senator', 648),
    (u'New Year', 648),
    (u'Mattie', 647),
    (u'Coyote', 646),
    (u'Rubens', 645),
    (u'Carol Jeanne', 645),
    (u'Shaftoe', 645),
    (u'Einstein', 645),
    (u'Becky', 645),
    (u'Pat', 644),
    (u'Gus', 644),
    (u'Estarra', 642),
    (u'Jessie', 639),
    (u'Brad', 639),
    (u'Jeannie', 639),
    (u'Capitol', 639),
    (u'Lev', 638),
    (u'South America', 638),
    (u'Bradley', 637),
    (u'Andie', 637),
    (u'Ernie', 636),
    (u'Irving', 636),
    (u'Judy', 636),
    (u'Waterhouse', 636),
    (u'Jon', 635),
    (u'Wireman', 635),
    (u'Tremane', 634),
    (u'Mitchell', 634),
    (u'Clio', 634),
    (u'Tasia', 634),
    (u'Clara', 634),
    (u'Gregor', 633),
    (u'Gracie', 633),
    (u'Fitz', 632),
    (u'Luc', 631),
    (u'Nathan', 630),
    (u'Service', 629),
    (u'Faye', 629),
    (u'Cadillac', 628),
    (u'Garraty', 628),
    (u'Maya', 628),
    (u'Bundle', 628),
    (u'Burke', 627),
    (u'Linda', 627),
    (u'Cass', 627),
    (u'Satan', 626),
    (u'Sebastian', 626),
    (u'Lawrence', 626),
    (u'Er', 626),
    (u'Walker', 624),
    (u'Oz', 624),
    (u'Battle School', 624),
    (u'Harvath', 622),
    (u'Izzy', 621),
    (u'Rusty', 621),
    (u'Keely', 621),
    (u'Taleswapper', 621),
    (u'Rory', 620),
    (u'Miami', 620),
    (u'Thank', 619),
    (u'Head', 619),
    (u'Room', 618),
    (u'Pitt', 618),
    (u'Melody', 617),
    (u'Viktor', 616),
    (u'Fire', 616),
    (u'Coleman', 616),
    (u'Ishmael', 615),
    (u'Magnus', 615),

]
def get_proper_nouns():
    return set([x[0] for x in ALL_NAMES if x not in OK_NAMES])

def get_proper_nouns_in_sentence(sentence):
    res = []
    tokenized_sentence = word_tokenize(sentence)
    #    print(tokenized_sentence)
    tagged_sentence = pos_tag(tokenized_sentence)
    #    print(tagged_sentence)

    start = True
    current_nnp_candidate = []

    for word, tag in tagged_sentence:
        if start:
            # NNP early is often not a proper noun so skip it.
            start = False
        elif tag == 'NNP':
            current_nnp_candidate.append(word)
        else:
            if current_nnp_candidate:
                res.append(' '.join(current_nnp_candidate))
                current_nnp_candidate = []

    if current_nnp_candidate:
        res.append(' '.join(current_nnp_candidate))
    return res

def count_pnns(text):
    sentence_data = nltk_data_load('tokenizers/punkt/english.pickle')
    pn_counter = Counter()
    for sentence in sentence_data.tokenize(text):
        pns = get_proper_nouns_in_sentence(sentence)
        #        print(pns)
        pn_counter.update(Counter(pns))
    return pn_counter


def load_and_clean_textfile(filename):
    try:
        with codecs.open(filename, "r", "utf-8") as open_file:
            raw_text = open_file.read()
    except UnicodeDecodeError as uee:
        print(uee)
        with codecs.open(filename, "r", "iso-8859-15") as open_file:
            raw_text = open_file.read()
    text = (raw_text.
            replace('\n', ' ').
            replace(u'\u2122', "(tm)").
            replace(u'\u2013', "-").
            replace(u'\u2014', " - ").
            replace(u'\u2019', "'").
            replace(u'\u2018', "'").
            replace(u'\u201c', '"').
            replace(u'``', '"').
            replace(u'\'\'', '"').
            replace(u'`', '\'').
            replace(u'\u201d', '"').
            replace(u'\u2026', '...').
            strip())
    return text
    

def main():

    import nltk
    try:
        pos_tag("")
    except LookupError as e:
        print(e)
        nltk.download()
        pos_tag("")

    text = "Forgy Swenson ate lunch with the red dog Barks. Later Forgy walked down the streets of London. Maybe some day she will meet Barks again."
    pn_counter = count_pnns(text)
    print(pn_counter)
    from nltk.stem import WordNetLemmatizer

    corpus3_data = calibreimport.get_text_meta_file_tuples()
    np.random.shuffle(corpus3_data)
    #    corpus3 = [x[0] for x in corpus3_data]
    all_names = Counter()
    new_names = Counter()
    for (filename, _metafile) in corpus3_data:
        print(filename)
        text = load_and_clean_textfile(filename)
        print("Analyzing text...")
        pn_counter = count_pnns(text)
        for ok_word in OK_NAMES:
            if ok_word in pn_counter:
                del pn_counter[ok_word]
        all_names.update(pn_counter)
        for (known_name, _) in ALL_NAMES:
            if known_name in pn_counter:
                del pn_counter[known_name]
        new_names.update(pn_counter)
                #       for (name, count) in pn_counter.iteritems():
                #            all_names[name] += int(math.log(count))
        print("NAMES: %s" % str(pn_counter.most_common(16)))
        print()
        print("ALL NAMES: %s" % str(all_names.most_common(8)))
        print()
        print("NEW NAMES: %s" % str(new_names.most_common(200)))

if __name__ == "__main__":
    main()
